<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED MQTT æ§åˆ¶æ¸¬è©¦</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "lit": "https://cdn.jsdelivr.net/npm/lit@3.2.1/index.js",
                "lit/": "https://cdn.jsdelivr.net/npm/lit@3.2.1/",
                "lit-html": "https://cdn.jsdelivr.net/npm/lit-html@3.2.1/lit-html.js",
                "lit-html/": "https://cdn.jsdelivr.net/npm/lit-html@3.2.1/",
                "lit-element": "https://cdn.jsdelivr.net/npm/lit@3.2.1/index.js",
                "lit-element/": "https://cdn.jsdelivr.net/npm/lit@3.2.1/",
                "lit-element/lit-element.js": "https://cdn.jsdelivr.net/npm/lit@3.2.1/index.js",
                "@lit/reactive-element": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@2.0.4/reactive-element.js",
                "@lit/reactive-element/": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@2.0.4/",
                "@lit/reactive-element/decorators": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@2.0.4/decorators.js",
                "@lit/reactive-element/decorators/": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@2.0.4/decorators/"
            }
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        .led-panel {
            text-align: center;
            margin: 20px 0;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .api-examples {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        .mqtt-examples {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        h1, h2 {
            color: #333;
        }
        .success-info {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .mqtt-publisher-panel {
            background: #e9ecef;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
            border-left: 4px solid #17a2b8;
        }
        .mqtt-publisher-panel div {
            margin-bottom: 10px;
        }
        .mqtt-publisher-panel label {
            display: inline-block;
            width: 150px; /* Adjust as needed */
            margin-right: 5px;
        }
        .mqtt-publisher-panel input[type="text"],
        .mqtt-publisher-panel input[type="password"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .mqtt-publisher-panel button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .mqtt-publisher-panel button:hover {
            background-color: #0056b3;
        }
        .mqtt-publisher-panel button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .mqtt-publisher-panel .status.error {
            color: #721c24;
            background-color: #f8d7da;
            padding: 5px;
            border-radius: 3px;
        }
        .mqtt-publisher-panel .status.success {
            color: #155724;
            background-color: #d4edda;
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”´ LED MQTT æ§åˆ¶é¢æ¿</h1>
        
        <div class="success-info">
            <h3>âœ… ç³»çµ±å°±ç·’</h3>
            <p>MQTT LED å…ƒä»¶å·²è¼‰å…¥å®Œæˆï¼Œæ”¯æ´æœ¬åœ°æ§åˆ¶å’Œé ç«¯ MQTT æ§åˆ¶ï¼</p>
        </div>
        
        <div class="info">
            <h2>æœ¬åœ°æ§åˆ¶ API</h2>
            <p>æ‚¨å¯ä»¥åœ¨ç€è¦½å™¨çš„ console ä¸­ä½¿ç”¨ä»¥ä¸‹ API ä¾†æ§åˆ¶ LEDï¼š</p>
            <div class="api-examples">
                led.on()        // é»äº® LED<br>
                led.off()       // é—œé–‰ LED<br>
                led.toggle()    // åˆ‡æ› LED ç‹€æ…‹<br>
                led.setColor('blue')   // è¨­å®šé¡è‰²<br>
                led.setSize(50)        // è¨­å®šå¤§å° (ç›´å¾‘ px)<br>
                led.getState()         // å–å¾—ç›®å‰ç‹€æ…‹
            </div>
        </div>

        <div class="info">
            <h2>ğŸŒ MQTT é ç«¯æ§åˆ¶</h2>
            <p>ç™¼é€ MQTT è¨Šæ¯åˆ°ä»¥ä¸‹ topic å³å¯é ç«¯æ§åˆ¶ LEDï¼š</p>
            <div class="mqtt-examples">
                Topic: led/command<br>
                è¨Šæ¯æ ¼å¼:<br>
                â€¢ {"command": "on()"} - é–‹å•Ÿ LED<br>
                â€¢ {"command": "off()"} - é—œé–‰ LED<br>
                â€¢ {"command": "toggle()"} - åˆ‡æ›ç‹€æ…‹<br>
                â€¢ {"command": "setColor('blue')"} - è¨­å®šé¡è‰²<br>
                â€¢ {"command": "setSize(60)"} - è¨­å®šå¤§å°<br>
                â€¢ {"command": "getState()"} - å–å¾—ç‹€æ…‹
            </div>
        </div>

        <div class="led-panel">
            <h2>MQTT LED å…ƒä»¶</h2>
            <led-light id="myLed" color="red" diameter="40" mqtt-sub="led"></led-light>
            <div id="status" class="status">æ­£åœ¨è¼‰å…¥å…ƒä»¶...</div>
            <p>é»æ“Š LED å¯ä»¥åˆ‡æ›é–‹é—œç‹€æ…‹</p>
        </div>

        <!-- MQTT Publisher Test Panel -->
        <div class="mqtt-publisher-panel">
            <h2>MQTT Publisher Test</h2>
            <p>Use this to send commands to the <code>led/command</code> topic (or any other topic).</p>
            <div>
                <label for="mqttHost">Broker URL:</label>
                <input type="text" id="mqttHost" value="wss://mqtt-edu.webduino.io/mqtt" style="width: 200px;">
            </div>
            <div>
                <label for="mqttUsername">Username:</label>
                <input type="text" id="mqttUsername" value="hsh2025">
            </div>
            <div>
                <label for="mqttPassword">Password:</label>
                <input type="password" id="mqttPassword" value="hsh2025">
            </div>
            <div>
                <label for="mqttTopic">Target Topic:</label>
                <input type="text" id="mqttTopic" value="led/command">
            </div>
            <div>
                <label for="mqttCommandInput">Command Payload:</label>
                <input type="text" id="mqttCommandInput" placeholder="e.g., on() or setColor('green')" style="width: 250px;">
                <button id="sendMqttCommandBtn">Send Command</button>
            </div>
            <div id="mqttPublisherStatus" class="status" style="margin-top: 10px;">Publisher not connected.</div>
        </div>
        <!-- End MQTT Publisher Test Panel -->

    </div>

    <script type="module">
        // ä¸»è¦åˆå§‹åŒ–å‡½æ•¸
        async function initializeApp() {
            console.log('ğŸ”„ é–‹å§‹è¼‰å…¥ LED å…ƒä»¶...');
            
            try {
                // å‹•æ…‹è¼‰å…¥ LED å…ƒä»¶
                await import('./led-light.js');
                console.log('âœ… LED å…ƒä»¶è¼‰å…¥æˆåŠŸ');
                
                // ç­‰å¾…ä¸€ä¸‹è®“å…ƒä»¶è¨»å†Šå®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 200));
                
                setupLedAPI();
                
            } catch (error) {
                console.error('âŒ LED å…ƒä»¶è¼‰å…¥å¤±æ•—:', error);
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = `âŒ å…ƒä»¶è¼‰å…¥å¤±æ•—: ${error.message}`;
                    statusElement.classList.add('error');
                }
            }
        }
        
        // è¨­å®š LED API
        function setupLedAPI() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LED API...');
            
            const ledElement = document.getElementById('myLed');
            
            if (!ledElement) {
                console.error('âŒ æ‰¾ä¸åˆ° LED å…ƒä»¶');
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = 'âŒ æ‰¾ä¸åˆ° LED å…ƒä»¶';
                    statusElement.classList.add('error');
                }
                return;
            }
            
            console.log('ğŸ“± LED å…ƒä»¶æ‰¾åˆ°ï¼Œè¨­å®šä¸­...', ledElement);
            
            // å»ºç«‹å…¨åŸŸ LED API ç‰©ä»¶ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
            window.led = {
                on: () => {
                    try {
                        if (typeof ledElement.turnOn === 'function') {
                            ledElement.turnOn();
                        } else {
                            ledElement.on = true;
                        }
                        console.log('âœ… LED å·²é»äº®');
                    } catch (error) {
                        console.error('âŒ é–‹å•Ÿ LED å¤±æ•—:', error);
                    }
                },
                
                off: () => {
                    try {
                        if (typeof ledElement.turnOff === 'function') {
                            ledElement.turnOff();
                        } else {
                            ledElement.on = false;
                        }
                        console.log('ğŸ”´ LED å·²é—œé–‰');
                    } catch (error) {
                        console.error('âŒ é—œé–‰ LED å¤±æ•—:', error);
                    }
                },
                
                toggle: () => {
                    try {
                        if (typeof ledElement.toggle === 'function') {
                            ledElement.toggle();
                        } else {
                            ledElement.on = !ledElement.on;
                        }
                        console.log(`ğŸ”„ LED å·²${ledElement.on ? 'é»äº®' : 'é—œé–‰'}`);
                    } catch (error) {
                        console.error('âŒ åˆ‡æ› LED å¤±æ•—:', error);
                    }
                },
                
                setColor: (color) => {
                    try {
                        if (typeof ledElement.setColor === 'function') {
                            ledElement.setColor(color);
                        } else {
                            ledElement.color = color;
                        }
                        console.log(`ğŸ¨ LED é¡è‰²å·²è¨­å®šç‚º: ${color}`);
                    } catch (error) {
                        console.error('âŒ è¨­å®šé¡è‰²å¤±æ•—:', error);
                    }
                },
                
                setSize: (diameter) => {
                    try {
                        if (typeof ledElement.setSize === 'function') {
                            ledElement.setSize(diameter);
                        } else {
                            ledElement.diameter = diameter;
                        }
                        console.log(`ğŸ“ LED å¤§å°å·²è¨­å®šç‚º: ${diameter}px`);
                    } catch (error) {
                        console.error('âŒ è¨­å®šå¤§å°å¤±æ•—:', error);
                    }
                },
                
                getState: () => {
                    try {
                        let state;
                        if (typeof ledElement.getState === 'function') {
                            state = ledElement.getState();
                        } else {
                            state = {
                                on: ledElement.on,
                                color: ledElement.color,
                                diameter: ledElement.diameter
                            };
                        }
                        console.log('ğŸ“Š LED ç›®å‰ç‹€æ…‹:', state);
                        return state;
                    } catch (error) {
                        console.error('âŒ å–å¾—ç‹€æ…‹å¤±æ•—:', error);
                        return null;
                    }
                }
            };
            
            // ç›£è½ LED è®ŠåŒ–äº‹ä»¶
            ledElement.addEventListener('led-change', (event) => {
                console.log('ğŸ“¡ LED ç‹€æ…‹è®ŠåŒ–:', event.detail);
            });
            
            // ç›£è½ MQTT é€£æ¥äº‹ä»¶
            ledElement.addEventListener('mqtt-connected', (event) => {
                console.log('ğŸŒ MQTT é€£æ¥æˆåŠŸ:', event.detail);
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = `âœ… MQTT å·²é€£æ¥ (Device: ${event.detail.deviceId})`;
                    statusElement.style.background = '#d4edda';
                    statusElement.style.borderColor = '#c3e6cb';
                    statusElement.classList.remove('error');
                }
            });
            
            // ç›£è½ MQTT éŒ¯èª¤äº‹ä»¶
            ledElement.addEventListener('mqtt-error', (event) => {
                console.error('âŒ MQTT é€£æ¥éŒ¯èª¤:', event.detail.error);
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = `âŒ MQTT é€£æ¥å¤±æ•—: ${event.detail.error}`;
                    statusElement.style.background = '#f8d7da';
                    statusElement.style.borderColor = '#f5c6cb';
                    statusElement.classList.add('error');
                }
            });
            
            // åˆå§‹ç‹€æ…‹æª¢æŸ¥
            const statusElement = document.getElementById('status');
            if (ledElement.mqttSub) {
                console.log('ğŸŒ MQTT åŠŸèƒ½å·²å•Ÿç”¨, topic:', ledElement.mqttSub);
                if (statusElement) {
                    statusElement.textContent = 'ğŸ”— æ­£åœ¨é€£æ¥ MQTT...';
                }
            } else {
                console.log('âš ï¸ MQTT åŠŸèƒ½æœªå•Ÿç”¨');
                if (statusElement) {
                    statusElement.textContent = 'âš ï¸ MQTT åŠŸèƒ½æœªå•Ÿç”¨ï¼ˆåƒ…æœ¬åœ°æ§åˆ¶ï¼‰';
                    statusElement.style.background = '#fff3cd';
                    statusElement.style.borderColor = '#ffeaa7';
                }
            }
            
            console.log('ğŸ‰ LED API å·²æº–å‚™å°±ç·’ï¼');
            console.log('ğŸ”´ æœ¬åœ°æ§åˆ¶æŒ‡ä»¤ï¼š');
            console.log('  led.on() - é»äº® LED');
            console.log('  led.off() - é—œé–‰ LED');
            console.log('  led.toggle() - åˆ‡æ›ç‹€æ…‹');
            console.log('  led.setColor("blue") - è¨­å®šé¡è‰²');
            console.log('  led.setSize(60) - è¨­å®šå¤§å°');
            console.log('  led.getState() - æŸ¥çœ‹ç‹€æ…‹');
            console.log('ğŸŒ MQTT æ§åˆ¶ï¼šç™¼é€è¨Šæ¯åˆ° led/command topic');
        }
        
        // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>

    <script>
    // MQTT Publisher Script
    document.addEventListener('DOMContentLoaded', () => {
        const hostInput = document.getElementById('mqttHost');
        const usernameInput = document.getElementById('mqttUsername');
        const passwordInput = document.getElementById('mqttPassword');
        const topicInput = document.getElementById('mqttTopic');
        const commandInput = document.getElementById('mqttCommandInput');
        const sendBtn = document.getElementById('sendMqttCommandBtn');
        const statusDisplay = document.getElementById('mqttPublisherStatus');

        let publisherClient = null;

        function connectPublisher() {
            if (publisherClient && publisherClient.connected) {
                // If already connected and details haven't changed, no need to reconnect
                // However, if called due to input change, we should force disconnect old one first
                // This is handled by the change event listeners calling .end(true) before connectPublisher()
            }

            if (publisherClient) { // If there's an existing client, ensure it's properly closed before creating a new one
                publisherClient.end(true, () => {
                    console.log('Previous publisher client ended.');
                    createNewPublisherConnection();
                });
            } else {
                createNewPublisherConnection();
            }
        }

        function createNewPublisherConnection() {
            const brokerUrl = hostInput.value.trim();
            const options = {
                clientId: `mqtt-publisher-${Math.random().toString(16).substr(2, 8)}`,
                username: usernameInput.value.trim(),
                password: passwordInput.value, // Password can be empty string
            };

            statusDisplay.textContent = `Connecting to ${brokerUrl}...`;
            statusDisplay.classList.remove('error', 'success');
            sendBtn.disabled = true;

            try {
                publisherClient = mqtt.connect(brokerUrl, options);
            } catch (error) {
                console.error("MQTT Connection Error (Publisher):", error);
                statusDisplay.textContent = `Error connecting: ${error.message}`;
                statusDisplay.classList.add('error');
                return;
            }

            publisherClient.on('connect', () => {
                console.log('MQTT Publisher connected.');
                statusDisplay.textContent = 'Publisher connected successfully.';
                statusDisplay.classList.remove('error');
                statusDisplay.classList.add('success');
                sendBtn.disabled = false;
            });

            publisherClient.on('error', (err) => {
                console.error('MQTT Publisher connection error:', err);
                statusDisplay.textContent = `Publisher error: ${err.message}`;
                statusDisplay.classList.add('error');
                sendBtn.disabled = true;
                if (publisherClient) {
                    publisherClient.end(true);
                    publisherClient = null;
                }
            });

            publisherClient.on('close', () => {
                console.log('MQTT Publisher disconnected.');
                // Avoid overriding a more specific error message if one was just set
                if (!statusDisplay.classList.contains('error')) {
                     statusDisplay.textContent = 'Publisher disconnected.';
                }
                sendBtn.disabled = true;
                publisherClient = null; // Ensure client is nulled out for re-connection logic
            });

            publisherClient.on('offline', () => {
                console.log('MQTT Publisher offline.');
                statusDisplay.textContent = 'Publisher is offline.';
                statusDisplay.classList.add('error');
                sendBtn.disabled = true;
            });
        }

        // Initial connection attempt
        connectPublisher();

        // Reconnect if connection details change
        hostInput.addEventListener('change', () => connectPublisher());
        usernameInput.addEventListener('change', () => connectPublisher());
        passwordInput.addEventListener('change', () => connectPublisher());

        sendBtn.addEventListener('click', () => {
            if (!publisherClient || !publisherClient.connected) {
                statusDisplay.textContent = 'Publisher not connected. Attempting to connect...';
                statusDisplay.classList.remove('success');
                statusDisplay.classList.add('error');
                connectPublisher(); // Attempt to reconnect
                return;
            }

            const topic = topicInput.value.trim();
            const commandStr = commandInput.value.trim();

            if (!topic || !commandStr) {
                statusDisplay.textContent = 'Topic and Command Payload cannot be empty.';
                statusDisplay.classList.remove('success');
                statusDisplay.classList.add('error');
                return;
            }

            const messagePayload = JSON.stringify({ command: commandStr });

            publisherClient.publish(topic, messagePayload, { qos: 0 }, (err) => {
                if (err) {
                    console.error('MQTT Publish error:', err);
                    statusDisplay.textContent = `Publish error: ${err.message}`;
                    statusDisplay.classList.remove('success');
                    statusDisplay.classList.add('error');
                } else {
                    console.log(`Published to ${topic}: ${messagePayload}`);
                    statusDisplay.textContent = `Sent to ${topic}: "${commandStr}"`;
                    statusDisplay.classList.remove('error');
                    statusDisplay.classList.add('success');
                }
            });
        });
    });
    </script>
</body>
</html> 